

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Smile">
  <meta name="keywords" content="">
  
    <meta name="description" content="介绍PostgreSQL中MemoryContext机制解析 内容1. MemoryContext概述MemoryContext 以功能为单位组织起来的树形数据结构，不同的阶段使用不同的 MemoryContext，它的存在是为了更清晰的管理内存。   合理管理碎片小内存。频繁的向 OS 申请和释放内存效率是很差的。MemoryContext 会以 trunk 为单位向 OS 申请成块的内存，并管">
<meta property="og:type" content="article">
<meta property="og:title" content="PostgreSQL中的WAL文件与LSN深入探索和分析">
<meta property="og:url" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/index.html">
<meta property="og:site_name" content="Smile">
<meta property="og:description" content="介绍PostgreSQL中MemoryContext机制解析 内容1. MemoryContext概述MemoryContext 以功能为单位组织起来的树形数据结构，不同的阶段使用不同的 MemoryContext，它的存在是为了更清晰的管理内存。   合理管理碎片小内存。频繁的向 OS 申请和释放内存效率是很差的。MemoryContext 会以 trunk 为单位向 OS 申请成块的内存，并管">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_1.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_2.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_3.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_4.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_5.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_6.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_8.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_7.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_9.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_10.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_11.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_12.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_13.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_14.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_15.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_16.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_17.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_18.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_19.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_20.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_21.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_22.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_23.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_24.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_25.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_26.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_27.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_28.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_29.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_30.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_31.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_32.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_33.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_34.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_35.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_36.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_37.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_38.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_39.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_40.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_41.png">
<meta property="og:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_42.png">
<meta property="article:published_time" content="2025-05-05T12:24:14.083Z">
<meta property="article:modified_time" content="2025-05-06T11:45:19.255Z">
<meta property="article:author" content="Smile">
<meta property="article:tag" content="database">
<meta property="article:tag" content="PostgreSQL">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img.png">
  
  
  
  <title>PostgreSQL中的WAL文件与LSN深入探索和分析 - Smile</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"smilemzy.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Smile</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="PostgreSQL中的WAL文件与LSN深入探索和分析"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-05-05 20:24" pubdate>
          2025年5月5日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          3.7k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          31 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">PostgreSQL中的WAL文件与LSN深入探索和分析</h1>
            
            
              <div class="markdown-body">
                
                <h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>PostgreSQL中MemoryContext机制解析</p>
<h4 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h4><h5 id="1-MemoryContext概述"><a href="#1-MemoryContext概述" class="headerlink" title="1. MemoryContext概述"></a>1. MemoryContext概述</h5><p>MemoryContext 以功能为单位组织起来的树形数据结构，不同的阶段使用不同的 MemoryContext，它的存在是为了更清晰的管理内存。  </p>
<p>合理管理碎片小内存。频繁的向 OS 申请和释放内存效率是很差的。<br>MemoryContext 会以 trunk 为单位向 OS 申请成块的内存，并管理起来。当程序需求小内存时从 trunk 中分配，<br>用完后归还给对应的 MemoryContext ，并不归还给 OS。<br>赋予内存功能和生命周期属性<br>（1）以功能为单位管理内存。不同功能和阶段使用对应的 MemoryContext。<br>（2）TopTransactionContext：一个事务的生命周期，事务管理相关数据放在 TopTransactionContext，当一个事务提交时该上下文被整个释放。  </p>
<p>树形的 MemoryContext 结构<br>（1）不同功能间的 MemoryContext 是以为树为单位组织起来的<br>（2）每个数据库后端进程顶层是 TopMemoryContext<br>（3）删除或重置一个 MemoryContext，它的子 MemoryContext 也一并被删除或重置。<br>（4）删除或重置一个 MemoryContext，它的子 MemoryContext 也一并被删除或重置。  </p>
<h5 id="2-内存上下文相关的四个数据类型"><a href="#2-内存上下文相关的四个数据类型" class="headerlink" title="2. 内存上下文相关的四个数据类型"></a>2. 内存上下文相关的四个数据类型</h5><p>相关数据结构</p>
<h6 id="2-1-MemoryContext"><a href="#2-1-MemoryContext" class="headerlink" title="2.1 MemoryContext"></a>2.1 MemoryContext</h6><p><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img.png" srcset="/img/loading.gif" lazyload alt="img.png"><br>下面是该数据类型中各成员变量所代表的含义：  </p>
<ul>
<li><p>type – 是一个枚举类型，用于标示内存上下文类型。在默认只有一种类型，T_AllocSetContext。<br>NodeTag声明于src&#x2F;include&#x2F;nodes&#x2F;nodes.h 头文件中，下面列出了与内存上下文节点相关的几个枚举值。<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_1.png" srcset="/img/loading.gif" lazyload alt="img_1.png">  </p>
</li>
<li><p>isReset – 如果为true，表明该上下文自从上次Reset（重置）后没有在上面分配过内存，可以避免一些不必要的操作。如果为false，则表明已经发生内存申请。  </p>
</li>
<li><p>allowInCritSection – 是否允许在临界区中分配内存。通常来说是不允许进行这样分配的，分配失败会导致PANIC，但这可以用于调试代码，方便开发调试，这些代码不建议进入实际生成环境中。    </p>
</li>
<li><p>mem_allocated – 跟踪为此上下文分配的内存。类似于C++ STL中的size()函数功能。  </p>
</li>
<li><p>methods – 记录了内存上下文使用的函数指针。类似于C++中的虚函数（vptr虚函数表），正如前面所言，MemoryContext类似于抽象类，所以存在虚函数是必须具有的。<br>methods的数据类型是MemoryContextMethods ，其结构如下：</p>
</li>
</ul>
<p><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_2.png" srcset="/img/loading.gif" lazyload alt="img_2.png">  </p>
<ul>
<li>parent – 内存上下文的父节点，对于TopMemoryContext，其parent字段为NULL，因为TopMemoryContext是所有内存上下文的父节点。  </li>
<li>firstchild – 它是树形结构中所有子内存上下文（双向）链表的头节点，TopMemoryContext父节点中的firstchild指针变量永远指向子内存上下文的链表头节点。详情请阅读本文的第4节内容的说明。  </li>
<li>prevchild – 同一个父节点下（即兄弟节点）的prev指针，用于指向该双向链表节点（这里的节点均指MemoryContext类型的内存上下文）的前一个节点。   </li>
<li>nextchild – 同一个父节点下（即兄弟节点）的next指针，用于指向该双向链表节点（这里的节点均指MemoryContext类型的内存上下文）的下一个节点。  </li>
<li>name – 具体MemoryContext的名称，比如对于TopMemoryContext内存上下文，则name即为“TopMemoryContext”，ErrorContext内存上下文，其name成员的值就是“ErrorContext”。不同的MemoryContext具有不同的名称，主要用于调试使用。  </li>
<li>ident – MemoryContext的ID，主要用于调试使用。  </li>
<li>reset_cbs – reset&#x2F;delete回调函数列表。它是Postgres 9.5中引入的一项功能，允许将内存上下文用于管理更多资源，而不仅仅是普通的palloc分配的内存。<br>这是通过为内存上下文注册“重置回调函数”来完成的。在下一次重置或删除上下文之前，将调用一次此类函数。它可以用来放弃在某种意义上与上下文中分配的对象相关联的资源。<br>其数据类型为MemoryContextCallback ，结构如下所示：</li>
</ul>
<p><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_3.png" srcset="/img/loading.gif" lazyload alt="img_3.png">  </p>
<p>在讲解了MemoryContext数据类型之后，下面就是MemoryContext抽象类的具体（也是唯一）实现AllocSetContext，参见本文的2.2节内容。  </p>
<h6 id="2-2-AllocSetContext"><a href="#2-2-AllocSetContext" class="headerlink" title="2.2 AllocSetContext"></a>2.2 AllocSetContext</h6><p>AllocSetContext是MemoryContext的标准实现。其结构如下：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_4.png" srcset="/img/loading.gif" lazyload alt="img_4.png"><br>下面将对这个AllocSetContext数据类型中的各成员进行讲解：  </p>
<ul>
<li>header – 标准的内存上下文区域，即抽象类型MemoryContext（可理解为子类对象中的基类对象的内存区域。），通过这个字段可以区分各内存上下文的层次关系（如本文第4节中的示意图所示）。  </li>
<li>blocks – 内存块链表，记录内存上下文向操作系统申请的连续大块内存。它是实际分配内存的地方，AllocSetContext中内存的分配是以Block（块）为单位向OS申请的，多个Block之间以单链表的方式连接起来。此blocks是单链表的头节点，在清除内存上下文时从它开始遍历整个链表，是否所有的Block中的内存。  </li>
<li>freelist – 组织该内存上下文里所有内存块中已释放的内存片的链表结构。它是一个数组成员，其数组大小是ALLOCSET_NUM_FREELISTS（该值是11）。freelist数组中各成员分别表示不同大小的AllocChunkData。在AllocSetContext的实现中，对于小的内存块（8 ~ 8192Byte）来说，当释放的时候不会归还给OS，而是将其缓存到freelist中。  </li>
<li>initBlockSizeBlock的初始化大小，默认8KB。  </li>
<li>maxBlockSizeBlock的最大大小。  </li>
<li>nextBlockSize下一个Block的大小。  </li>
<li>allocChunkLimit内存片的阈值，申请的内存超过此阀值直接分配新的block。  </li>
<li>keeper为防止一些需要频繁重置的小的内存上下文重复的进行malloc，重置时保留第一次申请的内存块。  </li>
<li>freeListIndex – 在context_freelists全局数组中的顺序，0表示默认freelist，1表示小内存的freelist，-1表示不需要进入freelist（比如超过allocChunkLimit的Block）。<br>context_freelists的的数据类型是AllocSetFreeList ，结构如下所示：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_5.png" srcset="/img/loading.gif" lazyload alt="img_5.png"></li>
</ul>
<p>注意：上面的AllocSetFreeList和AllocSetContext中的freelist不同，这里指的是空闲的AllocSetContextData，而非AllocChunkData。当发生delete时候，会将删除后的AllocSetContextData放入到AllocSetFreeList。  </p>
<h6 id="2-3-AllocBlockData"><a href="#2-3-AllocBlockData" class="headerlink" title="2.3 AllocBlockData"></a>2.3 AllocBlockData</h6><p>PostgreSQL向OS申请内存分配的基本单位是Block（块），一个Block可能被拆分为若干个Chunk，也可能只包含一个Chunk（比如较大块内存）。在chunk释放时候会放入freelist链表中，以便于下次分配，最后由Block统一释放归还给OS。<br>AllocBlockData的结构如下图所示：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_6.png" srcset="/img/loading.gif" lazyload alt="img_6.png"><br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_8.png" srcset="/img/loading.gif" lazyload alt="img_8.png">  </p>
<h6 id="2-4-AllocChunkData"><a href="#2-4-AllocChunkData" class="headerlink" title="2.4 AllocChunkData"></a>2.4 AllocChunkData</h6><p>AllocChunkData是AllocBlockData中每段内存的前缀。<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_7.png" srcset="/img/loading.gif" lazyload alt="img_7.png"><br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_9.png" srcset="/img/loading.gif" lazyload alt="img_9.png">  </p>
<h5 id="3-启动内存上下文子系统"><a href="#3-启动内存上下文子系统" class="headerlink" title="3. 启动内存上下文子系统"></a>3. 启动内存上下文子系统</h5><p>这必须在创建上下文或在上下文中分配内存之前调用。TopMemoryContext和ErrorContext在这里初始化；之后必须创建其他内存上下文。  </p>
<h6 id="3-1-初始化内存上下文"><a href="#3-1-初始化内存上下文" class="headerlink" title="3.1 初始化内存上下文"></a>3.1 初始化内存上下文</h6><p><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_10.png" srcset="/img/loading.gif" lazyload alt="img_10.png">  </p>
<p>CurrentMemoryContext、ErrorContext、PostmasterContext、CacheMemoryContext、MessageContext、TopTransactionContext、CurTransactionContext和PortalContext均作为TopMemoryContext的子上下文。<br>它们之间以树的形式进行分布与管理，这几个内存上下文之间的关系如图所示：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_11.png" srcset="/img/loading.gif" lazyload alt="img_11.png"><br>函数 MemoryContextInit 的实现如下：(postgresql-12.1\src\backend\utils\mmgr\mcxt.c)  </p>
<h6 id="3-2-初始化-TopMemoryContext"><a href="#3-2-初始化-TopMemoryContext" class="headerlink" title="3.2 初始化 TopMemoryContext"></a>3.2 初始化 TopMemoryContext</h6><p>首先，需要初始化TopMemoryContext内存上下文，因为它是所有其他内存上下文的父节点。<br>其初始化功能由函数AllocSetContextCreate()完成，该函数支持五个参数，其函数原型如下：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_12.png" srcset="/img/loading.gif" lazyload alt="img_12.png">  </p>
<p>由于是初始化TopMemoryContext内存上下文，所以第二个参数就以该内存上下文变量为名称（TopMemoryContext）。在这里，ALLOCSET_DEFAULT_SIZES是一个宏定义，其声明于文件src&#x2F;include&#x2F;utils&#x2F;memutils.h中。如下：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_13.png" srcset="/img/loading.gif" lazyload alt="img_13.png">  </p>
<p>AllocSetContextCreateInternal 实现解析：<br>postgresql-12.1\src\backend\utils\mmgr\aset.c  </p>
<p>####### 3.2.1 断言正确填充AllocChunkData<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_14.png" srcset="/img/loading.gif" lazyload alt="img_14.png"><br>StaticAssertStmt()函数类似于C++11中的static_assert断言宏，它接收两个参数，第一个参数是判别式，需要为true；第二个参数是在第一个判别式为false情况下进行的错误字符串信息打印，并终止进程。<br>因此这里若表达式 ALLOC_CHUNKHDRSZ &#x3D;&#x3D; MAXALIGN(ALLOC_CHUNKHDRSZ不为true 的时候，打印”sizeof(AllocChunkData) is not maxaligned”，并终止进程。<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_15.png" srcset="/img/loading.gif" lazyload alt="img_15.png"><br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_16.png" srcset="/img/loading.gif" lazyload alt="img_16.png"><br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_17.png" srcset="/img/loading.gif" lazyload alt="img_17.png">  </p>
<p>MAXIMUM_ALIGNOF的值是8，(???声明于Solution.pm文件中。)<br>因此，若sizeof(struct AllocChunkData)的值为8，则通过TYPEALIGN()宏的调用及内部位运算之后得到的值也是8，<br>即表达式ALLOC_CHUNKHDRSZ &#x3D;&#x3D; MAXALIGN(ALLOC_CHUNKHDRSZ为true，说明我们正确地填充了AllocChunkData，即struct AllocChunkData。  </p>
<p><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_18.png" srcset="/img/loading.gif" lazyload alt="img_18.png">  </p>
<p>####### 3.2.2 对参数进行校验<br>这里接着对函数AllocSetContextCreateInternal()中的第三、四、五个参数进行校验，用来判别其值是否合理、对齐。<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_19.png" srcset="/img/loading.gif" lazyload alt="img_19.png">  </p>
<p>函数AllocHugeSizeIsValid()是一个函数宏，声明于memutils.h文件中，用于检验“初始化最大分配块大小（maxBlockSize）”不能超过一定阈值。如下：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_20.png" srcset="/img/loading.gif" lazyload alt="img_20.png"><br>宏SIZE_MAX 声明于exprscan.c文件中：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_21.png" srcset="/img/loading.gif" lazyload alt="img_21.png">  </p>
<p>####### 3.2.3 检查参数是否与freelist匹配<br>这里是对TomMemoryContext内存上下文进行初始化，且其实参是minContextSize &#x3D; 0，initBlockSize &#x3D; 8 * 1024。所以freeListIndex &#x3D; 0。<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_22.png" srcset="/img/loading.gif" lazyload alt="img_22.png"><br>freeListIndex用于对全局结构体数组变量（context_freelists）中的成员进行释放操作，该结构体后面会详细说明。  </p>
<p>####### 3.2.4 如果有匹配的freelist，则释放其空间<br>由于这里freeListIndex &#x3D; 0，所以得到的freelist指针变量中其成员变量first_free的值为NULL，不会进入if (freelist-&gt;first_free !&#x3D; NULL)的函数体中。<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_23.png" srcset="/img/loading.gif" lazyload alt="img_23.png">  </p>
<p>####### 3.2.5 确定初始化块大小<br>ALLOC_BLOCKHDRSZ 和ALLOC_CHUNKHDRSZ都是一个宏，分别是等价于sizeof(AllocBlockData)和sizeof(struct AllocChunkData)。其中AllocBlockData声明如下：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_24.png" srcset="/img/loading.gif" lazyload alt="img_24.png"><br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_25.png" srcset="/img/loading.gif" lazyload alt="img_25.png"><br>实参minContextSize 的值为0，所以走else{}分支。其中initBlockSize的值是8KB，<br>显然这里的MAXALIGN(sizeof(AllocSetContext)) + ALLOC_BLOCKHDRSZ + ALLOC_CHUNKHDRSZ值是小于8KB的，因此firstBlockSize 最终的值是8KB。<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_26.png" srcset="/img/loading.gif" lazyload alt="img_26.png">  </p>
<p>####### 3.2.6 分配AllocSetContextData块<br>在得到了初始化块分配大小（firstBlockSize，8KB）之后，接下来就需要为我们的set申请内存空间，然后将这片内存地址强制转换为AllocSet类型。在这里需要对其内存申请结果状态信息进行判断。<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_27.png" srcset="/img/loading.gif" lazyload alt="img_27.png"><br>如果set的值为NULL，表明系统内存不足，申请失败。此时需要对TopMemoryContext内存向下文及其所有的子内存上下文进行打印其统计信息处理。<br>由函数MemoryContextStats()负责，同时打印相应的错误日志提示信息。函数MemoryContextStats()实现如下：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_28.png" srcset="/img/loading.gif" lazyload alt="img_28.png"><br>函数MemoryContextStatsDetail()实现如下：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_29.png" srcset="/img/loading.gif" lazyload alt="img_29.png"><br>在该函数体实现中，有一个新的结构体数据类型MemoryContextCounters ，它声明于memnodes.h(src&#x2F;include&#x2F;nodes&#x2F;memnodes.h)头文件中，详情如下：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_30.png" srcset="/img/loading.gif" lazyload alt="img_30.png"><br>在函数MemoryContextStatsDetail()内部间接调用MemoryContextStatsInternal()来进行子内存上下文的状态信息统计。<br>关于该函数的内部实现将不进行过多展开，只需要知道该函数内部完成TopMemoryContext中所有子内存上下文的状态信息（总空间、已使用空间、空闲空间等）统计。</p>
<p>####### 3.2.7 填写初始块的块头<br>当set内存申请成功后，它位于8KB的内存空间的头部。紧接着在set（AllocSet）数据类型的后面分配一个AllocBlock数据类型大小的空间。<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_31.png" srcset="/img/loading.gif" lazyload alt="img_31.png"><br>同时使set中的成员blocks和keeper指向新分配的block变量的位置。并使用函数AllocSetContextCreateInternal()中提供的参数来<br>初始化set中的成员变量initBlockSize、maxBlockSize等。并将set中的成员数组freelist的值全部初始化零操作（freelist数组大小是11）。<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_32.png" srcset="/img/loading.gif" lazyload alt="img_32.png"><br>当set（AllocSet类型）指针变量内存空间申请成功、以及block初始化完成之后，其set和block（AllocBlock）之间的关联示意图如下所示：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_33.png" srcset="/img/loading.gif" lazyload alt="img_33.png">  </p>
<p>####### 3.2.8 计算内存上下文分配内存片大小限制<br>接下来计算指定的内存上下文中的分配内存片大小限制。由于freelist成员数组大小固定（为数组大小是11），它不能超过ALLOC_CHUNK_LIMIT（8192Byte）。<br>如果 maxBlockSize 很小，那么超过 maxBlockSize 甚至很大一部分的请求也应该被视为大内存片。对于maxBlockSize的2次方的典型情况，<br>内存片大小的限制最多为maxBlockSize的1&#x2F;8，因此，给定一个全部为最大块内存片大小的请求流，我们最多会浪费1&#x2F;8的分配空间。<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_34.png" srcset="/img/loading.gif" lazyload alt="img_34.png"><br>们必须让allocChunkLimit是2的幂，因为任何内存片的请求大小和实际分配的大小都必须在限制的同一侧，否则我们会对该内存片是否 “big “感到困惑。<br>此外，allocChunkLimit不能超过ALLOCSET_SEPARATE_THRESHOLD（8192Byte）。<br>接下来要执行最为重要的一步就是初始化set指针变量中的其他成员的初始化操作。以及如果本次是非TopMemoryText内存上下文的初始化操作，<br>则需要将新创建的set添加到TopMemoryContext中。详细过程见3.2.9节内容。  </p>
<p>####### 3.2.9 执行与类型无关的上下文创建部分<br>执行与类型无关的内存上下文创建部分主要由函数MemoryContextCreate()负责完成，如下所示。<br>其中：<br>参数set是指向malloc的（8KB）内存空间地址，<br>T_AllocSetContext是该set的类型；<br>AllocSetMethods是一个指针数组，里面的各成员是函数指针，表明用来对内存上下文进行相关操作的函数实现；<br>parent是该内存上下文的父亲，如果是本次创建的内存上下文是TopMemoryContext，则parent参数为NULL；<br>name是该内存上下文的名字。<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_35.png" srcset="/img/loading.gif" lazyload alt="img_35.png"><br>实现如下：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_36.png" srcset="/img/loading.gif" lazyload alt="img_36.png"><br>该函数执行完成之后，其初始化效果如下图所示：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_37.png" srcset="/img/loading.gif" lazyload alt="img_37.png"><br>之后，重新初始化mem_allocated的值为firstBlockSize大小。并将set强制类型转换为MemoryContext。<br>并返回上层调用的具体待初始化的内存上下文，比如TopMemoryContext，或ErrorContext、PostmasterContext等。<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_38.png" srcset="/img/loading.gif" lazyload alt="img_38.png"><br>在执行完成TopMemoryContext内存上下文的初始化操作之后，接下来就是初始化ErrorContext，在该内存上下文初始化之后，其与TopMemoryContext之间的关联如下图所示：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_39.png" srcset="/img/loading.gif" lazyload alt="img_39.png"><br>紧接着执行PostmasterContext内存上下文的初始化，在初始化完成之后，其与TopMemoryContext、ErrorContext间的关联如下图所示：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_40.png" srcset="/img/loading.gif" lazyload alt="img_40.png">  </p>
<h5 id="4-内存上下文树形图"><a href="#4-内存上下文树形图" class="headerlink" title="4. 内存上下文树形图"></a>4. 内存上下文树形图</h5><p>在本文的第1节中也曾提到过，Mmeory Context是以树形结构来组织各内存上下文之间的关联关系。其中TopMemoryContext内存上下文是所有其他内存上下文的父（根）节点，<br>其中firstchild指针变量用于指向该节点的第一个孩子（内存上下文）节点。之后通过prevchild和nextchild指针变量可以分别向后、向前变量位于TopMemoryContext下的所有子内存上下文节点，就向一个双向链表。<br>此外，对于TopMemoryContext的子内存上下文节点，采用的是“前插法”的方式添加，详细细节如下图所示：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_41.png" srcset="/img/loading.gif" lazyload alt="img_41.png"><br>把ErrorContext、PostmasterContext和MessageContext这三个内存上下文中的parent指针变量的指向由折线修改为直线后的效果图如下所示：<br><img src="/2025/05/05/note/DB/postgresql/MemoryContext%E5%88%86%E6%9E%90/MemoryContext/img_42.png" srcset="/img/loading.gif" lazyload alt="img_42.png">  </p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/DB/" class="category-chain-item">DB</a>
  
  
    <span>></span>
    
  <a href="/categories/DB/PostgreSQL/" class="category-chain-item">PostgreSQL</a>
  
  
    <span>></span>
    
  <a href="/categories/DB/PostgreSQL/MemoryContext/" class="category-chain-item">MemoryContext</a>
  
  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/database/" class="print-no-link">#database</a>
      
        <a href="/tags/PostgreSQL/" class="print-no-link">#PostgreSQL</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>PostgreSQL中的WAL文件与LSN深入探索和分析</div>
      <div>http://smilemzy.com/2025/05/05/note/DB/postgresql/MemoryContext分析/MemoryContext/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Smile</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年5月5日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/05/05/note/DB/postgresql/PostgreSQL%E4%B8%AD%E7%9A%84WAL/WAL/" title="PostgreSQL中的WAL文件与LSN深入探索和分析">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">PostgreSQL中的WAL文件与LSN深入探索和分析</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/05/05/note/DB/postgresql/extension/PgExtension/pg_recovery/pg_recovery/" title="PostgreSQL pg_recovery 拓展插件">
                        <span class="hidden-mobile">PostgreSQL pg_recovery 拓展插件</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
